<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Waypoint WebSocket Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">
<h1 class="text-2xl font-bold mb-4">üìç Waypoint WebSocket Test</h1>

<div class="flex w-full max-w-6xl gap-4">
    <div class="flex-1 flex flex-col gap-4 min-w-0">
        <div class="bg-white shadow rounded-lg p-4">
            <div class="flex items-center gap-2 mb-4">
                <label class="font-medium">Plan ID:</label>
                <input id="planId" type="number" value="1" class="border rounded p-1 w-24" />
                <button onclick="connect()" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600">Connect</button>
                <button onclick="disconnect()" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">Disconnect</button>
            </div>

            <div class="flex gap-2 mb-4">
                <button onclick="initWaypoints()" class="flex-1 px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Refresh (init)</button>
                <button onclick="createWaypoint()" class="flex-1 px-3 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600">Create Waypoint</button>
            </div>
        </div>

        <div class="bg-white shadow rounded-lg p-4">
            <h2 class="font-semibold mb-2">ÏÉà Waypoint ÏûÖÎ†•</h2>
            <div class="grid grid-cols-2 gap-3">
                <label class="flex flex-col">
                    Ïù¥Î¶Ñ
                    <input type="text" id="wpName" class="border rounded p-2" />
                </label>
                <label class="flex flex-col">
                    Ïπ¥ÌÖåÍ≥†Î¶¨
                    <select id="wpCategory" class="border rounded p-2">
                        <option value="" selected disabled>Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù</option>
                        <option value="DEFAULT">DEFAULT</option>
                        <option value="FOOD">FOOD</option>
                        <option value="CULTURE">CULTURE</option>
                        <option value="ACCOMMODATION">ACCOMMODATION</option>
                        <option value="TOUR">TOUR</option>
                        <option value="TRANSPORTATION">TRANSPORTATION</option>
                    </select>
                </label>

                <label class="flex flex-col col-span-2">
                    ÏÑ§Î™Ö
                    <input type="text" id="wpDescription" class="border rounded p-2" />
                </label>

                <label class="flex flex-col col-span-2">
                    Ï£ºÏÜå
                    <input type="text" id="wpAddress" class="border rounded p-2" />
                </label>

                <label class="flex flex-col">
                    ÏãúÏûë ÏãúÍ∞Ñ
                    <input type="datetime-local" id="wpStartTime" class="border rounded p-2" />
                </label>
                <label class="flex flex-col">
                    Ï¢ÖÎ£å ÏãúÍ∞Ñ
                    <input type="datetime-local" id="wpEndTime" class="border rounded p-2" />
                </label>

                <label class="flex flex-col">
                    X Ï¢åÌëú (float)
                    <input type="number" id="wpX" step="0.01" class="border rounded p-2" />
                </label>
                <label class="flex flex-col">
                    Y Ï¢åÌëú (float)
                    <input type="number" id="wpY" step="0.01" class="border rounded p-2" />
                </label>
            </div>
        </div>

        <div class="bg-white shadow rounded-lg p-4 flex-1 min-w-0">
            <h2 class="font-semibold mb-2">Î°úÍ∑∏</h2>
            <div id="log"
                 class="border rounded p-2 h-64 overflow-auto bg-gray-50 text-sm font-mono break-all whitespace-pre-wrap"></div>
        </div>
    </div>

    <div class="flex-1">
        <div class="bg-white shadow rounded-lg p-4 h-full flex flex-col">
            <h2 class="font-semibold mb-2">Waypoint Î™©Î°ù</h2>
            <div id="waypointList" class="border rounded p-2 overflow-auto flex-1 bg-gray-50"></div>
        </div>
    </div>
</div>
</body>

<script>
    let client = null;
    let connected = false;

    // ---------- Ïú†Ìã∏ ----------
    function log(message, type = "info") {
        const logBox = document.getElementById("log");
        const line = document.createElement("div");
        line.className =
            type === "success" ? "text-green-600"
                : type === "error" ? "text-red-600"
                    : type === "send" ? "text-blue-600"
                        : "text-gray-800";
        line.textContent = message;
        logBox.appendChild(line);
        logBox.scrollTop = logBox.scrollHeight;
    }

    function parseOrNull(numStr) {
        if (numStr === null || numStr === undefined) return null;
        const n = parseFloat(numStr);
        return Number.isNaN(n) ? null : n;
    }

    // ÏÑúÎ≤ÑÏóêÏÑú Ïò® ISO-like Î¨∏ÏûêÏó¥ÏùÑ datetime-local Í∞íÏúºÎ°ú ÎßûÏ∂§ (Ï¥à/Î∞ÄÎ¶¨Ï¥à Ï†úÍ±∞)
    function toLocalDatetimeInput(v) {
        if (!v) return "";
        // ÏòàÏÉÅ: "2025-09-06T12:34" ÎòêÎäî "2025-09-06T12:34:56"
        return v.toString().slice(0, 16);
    }

    // ---------- Ïó∞Í≤∞ ----------
    function connect() {
        const planId = document.getElementById("planId").value;

        client = new StompJs.Client({
            webSocketFactory: () => new SockJS("http://localhost:8080/ws"),
            reconnectDelay: 5000,
        });

        client.onConnect = () => {
            connected = true;
            log("‚úÖ Connected to WebSocket", "success");

            // ÌîåÎûú Îã®ÏúÑ Î∏åÎ°úÎìúÏ∫êÏä§Ìä∏ Íµ¨ÎèÖ
            client.subscribe(`/topic/plans/${planId}`, (msg) => {
                log("üì© Received: " + msg.body, "info");
                renderWaypoints(msg.body);
            });

            // Ï†ëÏÜç ÌõÑ Ï†ÑÏ≤¥ ÎèôÍ∏∞Ìôî
            initWaypoints();
        };

        client.onWebSocketError = (err) => log("WebSocket error: " + err, "error");
        client.onStompError = (frame) => log("Broker error: " + JSON.stringify(frame), "error");

        client.activate();
    }

    function disconnect() {
        if (client) {
            client.deactivate();
            connected = false;
            log("‚ùå Disconnected", "error");
        }
    }

    // ---------- Ïï°ÏÖò ----------
    function initWaypoints() {
        const planId = document.getElementById("planId").value;
        client.publish({ destination: `/app/plans/${planId}/waypoints/init` });
        log("‚û°Ô∏è Sent init request", "send");
    }

    function createWaypoint() {
        const planId = document.getElementById("planId").value;

        const waypoint = {
            name: document.getElementById("wpName").value,
            description: document.getElementById("wpDescription").value,
            address: document.getElementById("wpAddress").value,
            startTime: document.getElementById("wpStartTime").value || null,
            endTime: document.getElementById("wpEndTime").value || null,
            locationCategory: document.getElementById("wpCategory").value || null, // ENUM Ïù¥Î¶Ñ
            xPosition: parseFloat(document.getElementById("wpX").value),
            yPosition: parseFloat(document.getElementById("wpY").value)
        };

        client.publish({
            destination: `/app/plans/${planId}/waypoints/create`, // dotted Ïä§ÌÉÄÏùº
            body: JSON.stringify(waypoint),
            headers: { "content-type": "application/json" },
        });
        log("‚û°Ô∏è Sent create request: " + JSON.stringify(waypoint), "send");
    }

    function deleteWaypointById(waypointId) {
        const planId = document.getElementById("planId").value;
        client.publish({
            destination: `/app/plans/${planId}/waypoints/${waypointId}/delete`, // dotted Ïä§ÌÉÄÏùº
        });
        log(`‚û°Ô∏è Sent delete request for waypointId=${waypointId}`, "send");
    }

    function updateWaypointById(waypointId, card) {
        const updatedWaypoint = {
            name: card.querySelector(".wp-name").value,
            description: card.querySelector(".wp-description").value,
            address: card.querySelector(".wp-address").value,
            startTime: card.querySelector(".wp-startTime").value || null,
            endTime: card.querySelector(".wp-endTime").value || null,
            locationCategory: card.querySelector(".wp-category").value || null,
            xPosition: parseOrNull(card.querySelector(".wp-x").value),
            yPosition: parseOrNull(card.querySelector(".wp-y").value),
        };

        const planId = document.getElementById("planId").value;
        client.publish({
            destination: `/app/plans/${planId}/waypoints/${waypointId}/update`, // dotted Ïä§ÌÉÄÏùº
            body: JSON.stringify(updatedWaypoint),
            headers: { "content-type": "application/json" },
        });
        log("‚û°Ô∏è Sent update request: " + JSON.stringify(updatedWaypoint), "send");
    }

    // ---------- Î†åÎçîÎßÅ ----------
    function renderWaypoints(messageBody) {
        const container = document.getElementById("waypointList");
        container.innerHTML = "";

        let payload;
        try {
            payload = JSON.parse(messageBody);
        } catch (e) {
            log("JSON parse error", "error");
            return;
        }

        // Í∏∞ÎåÄ Ìè¨Îß∑: { type: "FULL_UPDATE", waypoints: WaypointResponse[] }
        if (!payload || payload.type !== "FULL_UPDATE" || !Array.isArray(payload.waypoints)) {
            return;
        }

        payload.waypoints.forEach((wp) => {
            const card = document.createElement("div");
            card.className = "wp-card border rounded p-4 bg-white shadow-sm mb-3 flex flex-col gap-3";

            card.innerHTML = `
        <div class="flex justify-between items-start gap-2">
          <input class="wp-name border rounded p-2 flex-1 font-bold text-blue-600" value="${wp.name ?? ""}" />
          <div class="flex gap-1">
            <button
              onclick="updateWaypointById(${wp.id}, this.closest('.wp-card'))"
              class="px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-sm"
            >ÏàòÏ†ï</button>
            <button
              onclick="deleteWaypointById(${wp.id})"
              class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm"
            >ÏÇ≠Ï†ú</button>
          </div>
        </div>

        <label class="flex flex-col text-sm">
          ÏÑ§Î™Ö
          <input class="wp-description border rounded p-2" value="${wp.description ?? ""}" />
        </label>

        <label class="flex flex-col text-sm">
          Ï£ºÏÜå
          <input class="wp-address border rounded p-2" value="${wp.address ?? ""}" />
        </label>

        <div class="grid grid-cols-2 gap-3 text-sm">
          <label class="flex flex-col">
            ÏãúÏûë ÏãúÍ∞Ñ
            <input type="datetime-local" class="wp-startTime border rounded p-2" value="${toLocalDatetimeInput(wp.startTime)}" />
          </label>
          <label class="flex flex-col">
            Ï¢ÖÎ£å ÏãúÍ∞Ñ
            <input type="datetime-local" class="wp-endTime border rounded p-2" value="${toLocalDatetimeInput(wp.endTime)}" />
          </label>
        </div>

        <div class="grid grid-cols-3 gap-3 text-sm">
          <label class="flex flex-col">
            Ïπ¥ÌÖåÍ≥†Î¶¨ (ENUM)
            <input class="wp-category border rounded p-2" value="${wp.locationCategory ?? ""}" />
          </label>
          <label class="flex flex-col">
            X Ï¢åÌëú
            <input type="number" step="0.01" class="wp-x border rounded p-2" value="${wp.xPosition ?? ""}" />
          </label>
          <label class="flex flex-col">
            Y Ï¢åÌëú
            <input type="number" step="0.01" class="wp-y border rounded p-2" value="${wp.yPosition ?? ""}" />
          </label>
        </div>
      `;

            container.appendChild(card);
        });
    }
</script>
</html>