<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Waypoint & Memo WebSocket Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">
<h1 class="text-2xl font-bold mb-4">📍 Waypoint & 📝 Memo WebSocket Test</h1>

<div class="flex w-full max-w-6xl gap-4">
    <div class="flex-1 flex flex-col gap-4 min-w-0">
        <div class="bg-white shadow rounded-lg p-4">
            <div class="flex items-center gap-2 mb-4">
                <label class="font-medium">Plan ID:</label>
                <input id="planId" type="number" value="1" class="border rounded p-1 w-24" />
                <button onclick="connect()" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600">Connect</button>
                <button onclick="disconnect()" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">Disconnect</button>
            </div>
            <div class="flex gap-2 mb-4">
                <button onclick="initData()" class="flex-1 px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Refresh (init)</button>
                <button onclick="createWaypoint()" class="flex-1 px-3 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600">Create Waypoint</button>
                <button onclick="createMemo()" class="flex-1 px-3 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">Create Memo</button>
            </div>
        </div>

        <div class="bg-white shadow rounded-lg p-4">
            <h2 class="font-semibold mb-2">새 Waypoint 입력</h2>
            <div class="grid grid-cols-2 gap-3">
                <label class="flex flex-col">이름<input type="text" id="wpName" class="border rounded p-2" /></label>
                <label class="flex flex-col">카테고리
                    <select id="wpCategory" class="border rounded p-2">
                        <option value="" selected disabled>카테고리 선택</option>
                        <option value="DEFAULT">DEFAULT</option>
                        <option value="FOOD">FOOD</option>
                        <option value="CULTURE">CULTURE</option>
                        <option value="ACCOMMODATION">ACCOMMODATION</option>
                        <option value="TOUR">TOUR</option>
                        <option value="TRANSPORTATION">TRANSPORTATION</option>
                    </select>
                </label>
                <label class="flex flex-col col-span-2">설명<input type="text" id="wpDescription" class="border rounded p-2" /></label>
                <label class="flex flex-col col-span-2">주소<input type="text" id="wpAddress" class="border rounded p-2" /></label>
                <label class="flex flex-col">시작 시간<input type="datetime-local" id="wpStartTime" class="border rounded p-2" /></label>
                <label class="flex flex-col">종료 시간<input type="datetime-local" id="wpEndTime" class="border rounded p-2" /></label>
                <label class="flex flex-col">X 좌표 (float)<input type="number" id="wpX" step="0.01" class="border rounded p-2" /></label>
                <label class="flex flex-col">Y 좌표 (float)<input type="number" id="wpY" step="0.01" class="border rounded p-2" /></label>
            </div>
        </div>

        <div class="bg-white shadow rounded-lg p-4">
            <h2 class="font-semibold mb-2">새 Memo 입력</h2>
            <div class="grid grid-cols-2 gap-3">
                <label class="flex flex-col col-span-2">제목<input type="text" id="memoTitle" class="border rounded p-2" /></label>
                <label class="flex flex-col col-span-2">내용<input type="text" id="memoContent" class="border rounded p-2" /></label>
                <label class="flex flex-col">X 좌표 (float)<input type="number" id="memoX" step="0.01" class="border rounded p-2" /></label>
                <label class="flex flex-col">Y 좌표 (float)<input type="number" id="memoY" step="0.01" class="border rounded p-2" /></label>
            </div>
        </div>

        <div class="bg-white shadow rounded-lg p-4 flex-1 min-w-0">
            <h2 class="font-semibold mb-2">로그</h2>
            <div id="log" class="border rounded p-2 h-64 overflow-auto bg-gray-50 text-sm font-mono break-all whitespace-pre-wrap"></div>
        </div>
    </div>

    <div class="flex-1">
        <div class="bg-white shadow rounded-lg p-4 h-full flex flex-col">
            <h2 class="font-semibold mb-2">목록 (Waypoints + Memos)</h2>
            <div id="itemList" class="border rounded p-2 overflow-auto flex-1 bg-gray-50"></div>
        </div>
    </div>
</div>
</body>

<script>
    let client = null;

    // ---------- 유틸리티 함수 ----------
    function log(message, type = "info") {
        const logBox = document.getElementById("log");
        const line = document.createElement("div");
        const typeClasses = {
            success: "text-green-600",
            error: "text-red-600",
            send: "text-blue-600",
            info: "text-gray-800",
        };
        line.className = typeClasses[type] || typeClasses.info;
        line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logBox.appendChild(line);
        logBox.scrollTop = logBox.scrollHeight;
    }

    function parseOrNull(numStr) {
        if (numStr === null || numStr === undefined || numStr.trim() === "") return null;
        const n = parseFloat(numStr);
        return isNaN(n) ? null : n;
    }

    function toLocalDatetimeString(isoString) {
        if (!isoString) return "";
        // ISO 8601 형식에서 'YYYY-MM-DDTHH:mm' 부분만 잘라냅니다.
        return isoString.toString().slice(0, 16);
    }


    // ---------- WebSocket 연결 관리 ----------
    function connect() {
        const planId = document.getElementById("planId").value;
        if (!planId) {
            alert("Plan ID를 입력해주세요.");
            return;
        }

        if (client && client.connected) {
            log("이미 연결되어 있습니다.", "info");
            return;
        }

        client = new StompJs.Client({
            webSocketFactory: () => new SockJS("http://localhost:8080/ws"),
            reconnectDelay: 5000,
        });

        client.onConnect = () => {
            log(`✅ Connected to WebSocket for Plan ID: ${planId}`, "success");
            client.subscribe(`/topic/plans/${planId}`, (msg) => {
                log("📩 Received: " + msg.body, "info");
                renderItems(msg.body);
            });
            client.subscribe(`/user/queue/errors`, (msg) => {
                log("❌ Error: " + msg.body, "error");
                try {
                    const error = JSON.parse(msg.body);
                    alert(`에러 발생!\n[${error.code}] ${error.message}`);
                } catch (e) {
                    alert("에러 발생!\n" + msg.body);
                }
            });
            initData(); // 연결 성공 시 데이터 초기화
        };

        client.activate();
    }

    function disconnect() {
        if (client) {
            client.deactivate();
            log("🔌 Disconnected", "error");
            client = null;
        }
    }


    // ---------- 서버 액션 요청 ----------
    function publish(destination, body = null) {
        if (!client || !client.connected) {
            alert("먼저 연결해주세요.");
            return;
        }
        const headers = body ? { "content-type": "application/json" } : {};
        client.publish({ destination, body: body ? JSON.stringify(body) : null, headers });
        const logMessage = `➡️ Sent to ${destination}` + (body ? `: ${JSON.stringify(body)}` : "");
        log(logMessage, "send");
    }

    function initData() {
        const planId = document.getElementById("planId").value;
        publish(`/app/plans/${planId}/init`);
    }

    function createWaypoint() {
        const planId = document.getElementById("planId").value;
        const waypoint = {
            name: document.getElementById("wpName").value,
            description: document.getElementById("wpDescription").value,
            address: document.getElementById("wpAddress").value,
            startTime: document.getElementById("wpStartTime").value || null,
            endTime: document.getElementById("wpEndTime").value || null,
            locationCategory: document.getElementById("wpCategory").value || null,
            xPosition: parseOrNull(document.getElementById("wpX").value),
            yPosition: parseOrNull(document.getElementById("wpY").value),
        };
        publish(`/app/plans/${planId}/waypoints/create`, waypoint);
    }

    function updateWaypointById(waypointId, card) {
        const planId = document.getElementById("planId").value;
        const updatedWaypoint = {
            name: card.querySelector(".item-name").value,
            description: card.querySelector(".wp-description").value,
            address: card.querySelector(".wp-address").value,
            startTime: card.querySelector(".wp-startTime").value || null,
            endTime: card.querySelector(".wp-endTime").value || null,
            locationCategory: card.querySelector(".wp-category").value || null,
            xPosition: parseOrNull(card.querySelector(".wp-x").value),
            yPosition: parseOrNull(card.querySelector(".wp-y").value),
        };
        publish(`/app/plans/${planId}/waypoints/${waypointId}/update`, updatedWaypoint);
    }

    function deleteWaypointById(waypointId) {
        const planId = document.getElementById("planId").value;
        publish(`/app/plans/${planId}/waypoints/${waypointId}/delete`);
    }

    function createMemo() {
        const planId = document.getElementById("planId").value;
        const memo = {
            title: document.getElementById("memoTitle").value,
            content: document.getElementById("memoContent").value,
            xPosition: parseOrNull(document.getElementById("memoX").value),
            yPosition: parseOrNull(document.getElementById("memoY").value),
        };
        publish(`/app/plans/${planId}/memos/create`, memo);
    }

    function updateMemoById(memoId, card) {
        const planId = document.getElementById("planId").value;
        const updatedMemo = {
            title: card.querySelector(".item-name").value,
            content: card.querySelector(".memo-content").value,
            xPosition: parseOrNull(card.querySelector(".memo-x").value),
            yPosition: parseOrNull(card.querySelector(".memo-y").value),
        };
        publish(`/app/plans/${planId}/memos/${memoId}/update`, updatedMemo);
    }

    function deleteMemoById(memoId) {
        const planId = document.getElementById("planId").value;
        publish(`/app/plans/${planId}/memos/${memoId}/delete`);
    }


    // ---------- 렌더링 로직 (리팩토링) ----------

    /**
     * Waypoint에 해당하는 HTML 입력 필드 문자열을 생성합니다.
     * @param {object} wp - 웨이포인트 데이터 객체
     * @returns {string} HTML 문자열
     */
    function createWaypointFields(wp) {
        return `
            <label class="flex flex-col text-sm">설명
                <input class="wp-description border rounded p-2" value="${wp.description ?? ''}" />
            </label>
            <label class="flex flex-col text-sm">주소
                <input class="wp-address border rounded p-2" value="${wp.address ?? ''}" />
            </label>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <label class="flex flex-col">시작 시간
                    <input type="datetime-local" class="wp-startTime border rounded p-2" value="${toLocalDatetimeString(wp.startTime)}" />
                </label>
                <label class="flex flex-col">종료 시간
                    <input type="datetime-local" class="wp-endTime border rounded p-2" value="${toLocalDatetimeString(wp.endTime)}" />
                </label>
            </div>
            <div class="grid grid-cols-3 gap-3 text-sm">
                <label class="flex flex-col">카테고리
                    <select class="wp-category border rounded p-2">
                        <option value="DEFAULT" ${wp.locationCategory === 'DEFAULT' ? 'selected' : ''}>DEFAULT</option>
                        <option value="FOOD" ${wp.locationCategory === 'FOOD' ? 'selected' : ''}>FOOD</option>
                        <option value="CULTURE" ${wp.locationCategory === 'CULTURE' ? 'selected' : ''}>CULTURE</option>
                        <option value="ACCOMMODATION" ${wp.locationCategory === 'ACCOMMODATION' ? 'selected' : ''}>ACCOMMODATION</option>
                        <option value="TOUR" ${wp.locationCategory === 'TOUR' ? 'selected' : ''}>TOUR</option>
                        <option value="TRANSPORTATION" ${wp.locationCategory === 'TRANSPORTATION' ? 'selected' : ''}>TRANSPORTATION</option>
                    </select>
                </label>
                <label class="flex flex-col">X 좌표
                    <input type="number" step="0.01" class="wp-x border rounded p-2" value="${wp.xPosition ?? ''}" />
                </label>
                <label class="flex flex-col">Y 좌표
                    <input type="number" step="0.01" class="wp-y border rounded p-2" value="${wp.yPosition ?? ''}" />
                </label>
            </div>
        `;
    }

    /**
     * Memo에 해당하는 HTML 입력 필드 문자열을 생성합니다.
     * @param {object} memo - 메모 데이터 객체
     * @returns {string} HTML 문자열
     */
    function createMemoFields(memo) {
        return `
            <label class="flex flex-col text-sm">내용
                <input class="memo-content border rounded p-2" value="${memo.content ?? ''}" />
            </label>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <label class="flex flex-col">X 좌표
                    <input type="number" step="0.01" class="memo-x border rounded p-2" value="${memo.xPosition ?? ''}" />
                </label>
                <label class="flex flex-col">Y 좌표
                    <input type="number" step="0.01" class="memo-y border rounded p-2" value="${memo.yPosition ?? ''}" />
                </label>
            </div>
        `;
    }

    /**
     * 공통 카드 UI를 생성하는 범용 함수
     * @param {object} config - 카드 생성에 필요한 설정 객체
     * @returns {HTMLElement} 생성된 카드 div 엘리먼트
     */
    function createItemCard(config) {
        const card = document.createElement("div");
        card.className = `item-card ${config.type}-card border rounded p-4 bg-white shadow-sm mb-3 flex flex-col gap-3`;
        card.innerHTML = `
            <div class="flex justify-between items-start gap-2">
                <div class="flex-1 flex items-center gap-2">
                    <span class="text-xl">${config.icon}</span>
                    <input class="item-name border rounded p-2 flex-1 font-bold ${config.titleClass}" value="${config.title ?? ''}" />
                </div>
                <div class="flex gap-1">
                    <button onclick="${config.updateFn}(${config.id}, this.closest('.item-card'))"
                        class="px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-sm">수정</button>
                    <button onclick="${config.deleteFn}(${config.id})"
                        class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm">삭제</button>
                </div>
            </div>
            ${config.fieldsHtml}
        `;
        return card;
    }

    /**
     * 서버로부터 받은 데이터로 Waypoint와 Memo 목록을 렌더링합니다.
     * @param {string} messageBody - 서버에서 받은 JSON 문자열
     */
    function renderItems(messageBody) {
        const container = document.getElementById("itemList");
        container.innerHTML = "";

        let payload;
        try {
            payload = JSON.parse(messageBody);
        } catch (e) {
            log("JSON parse error", "error");
            return;
        }

        if (!payload || payload.type !== "FULL_UPDATE") return;

        // Waypoints 렌더링
        if (Array.isArray(payload.waypoints)) {
            payload.waypoints.forEach((wp) => {
                const card = createItemCard({
                    type: 'waypoint',
                    id: wp.id,
                    icon: '📍',
                    title: wp.name,
                    titleClass: 'text-blue-600',
                    fieldsHtml: createWaypointFields(wp),
                    updateFn: 'updateWaypointById',
                    deleteFn: 'deleteWaypointById'
                });
                container.appendChild(card);
            });
        }

        // Memos 렌더링
        if (Array.isArray(payload.memos)) {
            payload.memos.forEach((memo) => {
                const card = createItemCard({
                    type: 'memo',
                    id: memo.id,
                    icon: '📝',
                    title: memo.title,
                    titleClass: 'text-purple-700',
                    fieldsHtml: createMemoFields(memo),
                    updateFn: 'updateMemoById',
                    deleteFn: 'deleteMemoById'
                });
                container.appendChild(card);
            });
        }
    }
</script>
</html>