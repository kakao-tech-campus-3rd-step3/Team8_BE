<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Memo WebSocket Test (Real-time Input)</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">

<h1 class="text-2xl font-bold mb-4">📝 Memo WebSocket Test (실시간 입력 반영)</h1>

<div class="flex gap-4 mb-6">
    <input id="planId" type="number" value="1" placeholder="Plan ID"
           class="border rounded p-2 w-24">
    <button onclick="connect()"
            class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
        Connect
    </button>
    <button onclick="disconnect()"
            class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
        Disconnect
    </button>
    <button onclick="createMemoCard()"
            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
        + 새 메모
    </button>
</div>

<div id="log"
     class="bg-white border rounded p-2 w-[600px] h-32 overflow-auto text-sm mb-6"></div>

<div id="memoBoard"
     class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 w-full max-w-5xl">
</div>

<script>
    let client = null;
    let sessionId = null;
    let memos = [];

    function log(message, type = "info") {
        const logBox = document.getElementById("log");
        const div = document.createElement("div");
        const color = {
            info: "text-gray-700",
            success: "text-green-600",
            error: "text-red-600",
            send: "text-blue-600"
        }[type];
        div.className = color;
        div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logBox.appendChild(div);
        logBox.scrollTop = logBox.scrollHeight;
    }

    function connect() {
        const planId = document.getElementById("planId").value;
        if (!planId) return alert("Plan ID를 입력하세요");

        client = new StompJs.Client({
            webSocketFactory: () => new SockJS("http://localhost:8080/ws"),
            reconnectDelay: 3000
        });

        client.onConnect = () => {
            // 세션 ID 추출
            const url = client.webSocket._transport.url;
            const match = /\/([^\/]+)\/websocket/.exec(url);
            sessionId = match ? match[1] : "unknown";

            log(`✅ Connected | 내 세션 ID: ${sessionId}`, "success");

            // 구독
            client.subscribe(`/topic/plans/${planId}/memos`, (msg) => {
                const payload = JSON.parse(msg.body);

                // 자기 세션 무시
                if (payload.senderSessionId && payload.senderSessionId === sessionId) {
                    log("🚫 자기 세션 메시지 무시", "info");
                    return;
                }

                log(`📩 [Memo] ${payload.type}`, "info");

                switch (payload.type) {
                    case "INIT":
                        memos = payload.MEMO || [];
                        break;
                    case "CREATE":
                        memos.push(payload.MEMO);
                        break;
                    case "UPDATE":
                        const idx = memos.findIndex(m => m.id === payload.MEMO.id);
                        if (idx !== -1) memos[idx] = payload.MEMO;
                        else memos.push(payload.MEMO);
                        break;
                    case "DELETE":
                        memos = memos.filter(m => m.id !== payload.MEMO);
                        break;
                }
                renderMemos();
            });

            initData();
        };

        client.activate();
    }

    function disconnect() {
        if (client) {
            client.deactivate();
            log("🔌 Disconnected", "error");
        }
    }

    function publish(dest, body = {}) {
        const planId = document.getElementById("planId").value;
        if (!client || !client.connected) return alert("먼저 연결하세요");
        client.publish({
            destination: `/app/plans/${planId}${dest}`,
            body: JSON.stringify(body),
            headers: { "content-type": "application/json" }
        });
        log(`➡️ Sent: ${dest}`, "send");
    }

    function initData() {
        const planId = document.getElementById("planId").value;
        publish(`/memos/init`);
    }

    // -------------------------
    // 메모 관련 함수
    // -------------------------

    function createMemoCard() {
        const newMemo = {
            title: "새 메모",
            content: "",
            waypointId: null,
            routeId: null,
            xPosition: 50 + Math.random() * 200,
            yPosition: 50 + Math.random() * 200
        };
        publish(`/memos/create`, newMemo);
    }

    function updateMemo(id, data) {
        publish(`/memos/${id}/update`, data);
    }

    function deleteMemo(id) {
        publish(`/memos/${id}/delete`);
    }

    function renderMemos() {
        const board = document.getElementById("memoBoard");
        board.innerHTML = "";

        memos.forEach(memo => {
            const card = document.createElement("div");
            card.className = "bg-white border rounded-lg shadow p-4 flex flex-col gap-2";

            const titleInput = document.createElement("input");
            titleInput.className = "border-b p-1 text-purple-700 font-semibold focus:outline-none focus:border-purple-500";
            titleInput.value = memo.title;
            titleInput.placeholder = "제목 입력";

            const contentArea = document.createElement("textarea");
            contentArea.className = "border rounded p-2 text-sm text-gray-700 focus:outline-none focus:border-purple-500";
            contentArea.rows = 5;
            contentArea.placeholder = "내용 입력...";
            contentArea.value = memo.content || "";

            const deleteBtn = document.createElement("button");
            deleteBtn.className = "bg-red-500 hover:bg-red-600 text-white text-sm px-2 py-1 rounded self-end";
            deleteBtn.textContent = "삭제";
            deleteBtn.onclick = () => deleteMemo(memo.id);

            // ✅ 입력이 바뀔 때마다 즉시 서버에 전송 (디바운스 300ms)
            let typingTimer;
            function sendUpdate() {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                    const updated = {
                        id: memo.id,
                        title: titleInput.value.trim(),
                        content: contentArea.value.trim(),
                        waypointId: memo.waypointId ?? null,
                        routeId: memo.routeId ?? null,
                        xPosition: memo.xPosition ?? 0,
                        yPosition: memo.yPosition ?? 0
                    };
                    updateMemo(memo.id, updated);
                    log(`✏️ Memo ${memo.id} 실시간 수정 전송`, "send");
                }, 200);
            }


            titleInput.addEventListener("input", sendUpdate);
            contentArea.addEventListener("input", sendUpdate);

            card.appendChild(titleInput);
            card.appendChild(contentArea);
            card.appendChild(deleteBtn);
            board.appendChild(card);
        });
    }
</script>

</body>
</html>
