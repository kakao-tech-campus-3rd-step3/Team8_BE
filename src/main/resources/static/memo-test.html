<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Memo WebSocket Test (Real-time Input)</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">

<h1 class="text-2xl font-bold mb-4">ğŸ“ Memo WebSocket Test (ì‹¤ì‹œê°„ ì…ë ¥ ë°˜ì˜)</h1>

<div class="flex gap-4 mb-6">
    <input id="planId" type="number" value="1" placeholder="Plan ID"
           class="border rounded p-2 w-24">
    <button onclick="connect()"
            class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
        Connect
    </button>
    <button onclick="disconnect()"
            class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
        Disconnect
    </button>
    <button onclick="createMemoCard()"
            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
        + ìƒˆ ë©”ëª¨
    </button>
</div>

<div id="log"
     class="bg-white border rounded p-2 w-[600px] h-32 overflow-auto text-sm mb-6"></div>

<div id="memoBoard"
     class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 w-full max-w-5xl">
</div>

<script>
    let client = null;
    let sessionId = null;
    let memos = [];

    function log(message, type = "info") {
        const logBox = document.getElementById("log");
        const div = document.createElement("div");
        const color = {
            info: "text-gray-700",
            success: "text-green-600",
            error: "text-red-600",
            send: "text-blue-600"
        }[type];
        div.className = color;
        div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logBox.appendChild(div);
        logBox.scrollTop = logBox.scrollHeight;
    }

    function connect() {
        const planId = document.getElementById("planId").value;
        if (!planId) return alert("Plan IDë¥¼ ì…ë ¥í•˜ì„¸ìš”");

        client = new StompJs.Client({
            webSocketFactory: () => new SockJS("http://localhost:8080/ws"),
            reconnectDelay: 3000
        });

        client.onConnect = () => {
            // ì„¸ì…˜ ID ì¶”ì¶œ
            const url = client.webSocket._transport.url;
            const match = /\/([^\/]+)\/websocket/.exec(url);
            sessionId = match ? match[1] : "unknown";

            log(`âœ… Connected | ë‚´ ì„¸ì…˜ ID: ${sessionId}`, "success");

            // êµ¬ë…
            client.subscribe(`/topic/plans/${planId}/memos`, (msg) => {
                const payload = JSON.parse(msg.body);

                // ìê¸° ì„¸ì…˜ ë¬´ì‹œ
                if (payload.senderSessionId && payload.senderSessionId === sessionId) {
                    log("ğŸš« ìê¸° ì„¸ì…˜ ë©”ì‹œì§€ ë¬´ì‹œ", "info");
                    return;
                }

                log(`ğŸ“© [Memo] ${payload.type}`, "info");

                switch (payload.type) {
                    case "INIT":
                        memos = payload.MEMO || [];
                        break;
                    case "CREATE":
                        memos.push(payload.MEMO);
                        break;
                    case "UPDATE":
                        const idx = memos.findIndex(m => m.id === payload.MEMO.id);
                        if (idx !== -1) memos[idx] = payload.MEMO;
                        else memos.push(payload.MEMO);
                        break;
                    case "DELETE":
                        memos = memos.filter(m => m.id !== payload.MEMO);
                        break;
                }
                renderMemos();
            });

            initData();
        };

        client.activate();
    }

    function disconnect() {
        if (client) {
            client.deactivate();
            log("ğŸ”Œ Disconnected", "error");
        }
    }

    function publish(dest, body = {}) {
        const planId = document.getElementById("planId").value;
        if (!client || !client.connected) return alert("ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”");
        client.publish({
            destination: `/app/plans/${planId}${dest}`,
            body: JSON.stringify(body),
            headers: { "content-type": "application/json" }
        });
        log(`â¡ï¸ Sent: ${dest}`, "send");
    }

    function initData() {
        const planId = document.getElementById("planId").value;
        publish(`/memos/init`);
    }

    // -------------------------
    // ë©”ëª¨ ê´€ë ¨ í•¨ìˆ˜
    // -------------------------

    function createMemoCard() {
        const newMemo = {
            title: "ìƒˆ ë©”ëª¨",
            content: "",
            waypointId: null,
            routeId: null,
            xPosition: 50 + Math.random() * 200,
            yPosition: 50 + Math.random() * 200
        };
        publish(`/memos/create`, newMemo);
    }

    function updateMemo(id, data) {
        publish(`/memos/${id}/update`, data);
    }

    function deleteMemo(id) {
        publish(`/memos/${id}/delete`);
    }

    function renderMemos() {
        const board = document.getElementById("memoBoard");
        board.innerHTML = "";

        memos.forEach(memo => {
            const card = document.createElement("div");
            card.className = "bg-white border rounded-lg shadow p-4 flex flex-col gap-2";

            const titleInput = document.createElement("input");
            titleInput.className = "border-b p-1 text-purple-700 font-semibold focus:outline-none focus:border-purple-500";
            titleInput.value = memo.title;
            titleInput.placeholder = "ì œëª© ì…ë ¥";

            const contentArea = document.createElement("textarea");
            contentArea.className = "border rounded p-2 text-sm text-gray-700 focus:outline-none focus:border-purple-500";
            contentArea.rows = 5;
            contentArea.placeholder = "ë‚´ìš© ì…ë ¥...";
            contentArea.value = memo.content || "";

            const deleteBtn = document.createElement("button");
            deleteBtn.className = "bg-red-500 hover:bg-red-600 text-white text-sm px-2 py-1 rounded self-end";
            deleteBtn.textContent = "ì‚­ì œ";
            deleteBtn.onclick = () => deleteMemo(memo.id);

            // âœ… ì…ë ¥ì´ ë°”ë€” ë•Œë§ˆë‹¤ ì¦‰ì‹œ ì„œë²„ì— ì „ì†¡ (ë””ë°”ìš´ìŠ¤ 300ms)
            let typingTimer;
            function sendUpdate() {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                    const updated = {
                        id: memo.id,
                        title: titleInput.value.trim(),
                        content: contentArea.value.trim(),
                        waypointId: memo.waypointId ?? null,
                        routeId: memo.routeId ?? null,
                        xPosition: memo.xPosition ?? 0,
                        yPosition: memo.yPosition ?? 0
                    };
                    updateMemo(memo.id, updated);
                    log(`âœï¸ Memo ${memo.id} ì‹¤ì‹œê°„ ìˆ˜ì • ì „ì†¡`, "send");
                }, 200);
            }


            titleInput.addEventListener("input", sendUpdate);
            contentArea.addEventListener("input", sendUpdate);

            card.appendChild(titleInput);
            card.appendChild(contentArea);
            card.appendChild(deleteBtn);
            board.appendChild(card);
        });
    }
</script>

</body>
</html>
